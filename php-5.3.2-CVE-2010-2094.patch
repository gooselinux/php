
https://bugzilla.redhat.com/show_bug.cgi?id=598537
http://svn.php.net/viewvc?view=revision&revision=298667

plus fix of an additional case in phar_stream_flush.

--- php-5.3.2/ext/phar/dirstream.c.cve2094
+++ php-5.3.2/ext/phar/dirstream.c
@@ -360,7 +360,7 @@ php_stream *phar_wrapper_open_dir(php_st
 
 	if (FAILURE == phar_get_archive(&phar, resource->host, host_len, NULL, 0, &error TSRMLS_CC)) {
 		if (error) {
-			php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, error);
+			php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "%s", error);
 			efree(error);
 		} else {
 			php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "phar file \"%s\" is unknown", resource->host);
--- php-5.3.2/ext/phar/stream.c.cve2094
+++ php-5.3.2/ext/phar/stream.c
@@ -117,7 +117,7 @@ php_url* phar_parse_url(php_stream_wrapp
 		{
 			if (error) {
 				if (!(options & PHP_STREAM_URL_STAT_QUIET)) {
-					php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, error);
+					php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "%s", error);
 				}
 				efree(error);
 			}
@@ -128,7 +128,7 @@ php_url* phar_parse_url(php_stream_wrapp
 			if (error) {
 				spprintf(&error, 0, "Cannot open cached phar '%s' as writeable, copy on write failed", resource->host);
 				if (!(options & PHP_STREAM_URL_STAT_QUIET)) {
-					php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, error);
+					php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "%s", error);
 				}
 				efree(error);
 			}
@@ -140,7 +140,7 @@ php_url* phar_parse_url(php_stream_wrapp
 		{
 			if (error) {
 				if (!(options & PHP_STREAM_URL_STAT_QUIET)) {
-					php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, error);
+					php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "%s", error);
 				}
 				efree(error);
 			}
@@ -192,7 +192,7 @@ static php_stream * phar_wrapper_open_ur
 	if (mode[0] == 'w' || (mode[0] == 'r' && mode[1] == '+')) {
 		if (NULL == (idata = phar_get_or_create_entry_data(resource->host, host_len, internal_file, strlen(internal_file), mode, 0, &error, 1 TSRMLS_CC))) {
 			if (error) {
-				php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, error);
+				php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "%s", error);
 				efree(error);
 			} else {
 				php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "phar error: file \"%s\" could not be created in phar \"%s\"", internal_file, resource->host);
@@ -297,7 +297,7 @@ static php_stream * phar_wrapper_open_ur
 		if ((FAILURE == phar_get_entry_data(&idata, resource->host, host_len, internal_file, strlen(internal_file), "r", 0, &error, 0 TSRMLS_CC)) || !idata) {
 idata_error:
 			if (error) {
-				php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, error);
+				php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "%s", error);
 				efree(error);
 			} else {
 				php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "phar error: \"%s\" is not a file in phar \"%s\"", internal_file, resource->host);
@@ -320,7 +320,7 @@ idata_error:
 
 	/* check length, crc32 */
 	if (!idata->internal_file->is_crc_checked && phar_postprocess_file(idata, idata->internal_file->crc32, &error, 2 TSRMLS_CC) != SUCCESS) {
-		php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, error);
+		php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "%s", error);
 		efree(error);
 		phar_entry_delref(idata TSRMLS_CC);
 		efree(internal_file);
@@ -470,7 +470,7 @@ static int phar_stream_flush(php_stream 
 	if (stream->mode[0] == 'w' || (stream->mode[0] == 'r' && stream->mode[1] == '+')) {
 		ret = phar_flush(((phar_entry_data *)stream->abstract)->phar, 0, 0, 0, &error TSRMLS_CC);
 		if (error) {
-			php_stream_wrapper_log_error(stream->wrapper, REPORT_ERRORS TSRMLS_CC, error);
+			php_stream_wrapper_log_error(stream->wrapper, REPORT_ERRORS TSRMLS_CC, "%s", error);
 			efree(error);
 		}
 		return ret;
@@ -761,7 +761,7 @@ static int phar_wrapper_unlink(php_strea
 	efree(internal_file);
 	phar_entry_remove(idata, &error TSRMLS_CC);
 	if (error) {
-		php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, error);
+		php_stream_wrapper_log_error(wrapper, options TSRMLS_CC, "%s", error);
 		efree(error);
 	}
 	return 1;
